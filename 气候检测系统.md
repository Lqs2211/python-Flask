import traceback
import requests
import json
import tkinter as tk
from tkinter import ttk, messagebox, filedialog
import matplotlib.pyplot as plt
from matplotlib.backends.backend_tkagg import FigureCanvasTkAgg
import matplotlib
import warnings
import random
import numpy as np
from mpl_toolkits.mplot3d import Axes3D
import webbrowser
import os
from datetime import datetime

warnings.filterwarnings("ignore", category=UserWarning)
plt.rcParams['font.sans-serif'] = ['SimHei', 'Microsoft YaHei', 'DejaVu Sans']
plt.rcParams['axes.unicode_minus'] = False
plt.rcParams['figure.facecolor'] = 'white'
plt.rcParams['savefig.facecolor'] = 'white'

matplotlib.use('TkAgg')


class ShandongWeatherVisualization:
    def __init__(self, root):
        self.root = root
        self.root.title("全省各地市气候可视化系统 - 大棚农作物发育期检测")
        self.root.geometry("1600x1000")
        self.root.configure(bg='#f0f0f0')
        self.use_mock_data = True

        # 设备控制相关配置
        self.DEVICE_ID = 1368357  # 设备ID
        self.SANRE_API_TAG = "sanre"  # 传感标识名
        self.current_sanre_state = 0  # 当前设备状态：0=关闭，1=打开
        self.access_token = None


        self.shandong_cities = {
            "济南": "101120101",
            "青岛": "101120201",
            "淄博": "101120301",
            "枣庄": "101120401",
            "东营": "101121201",
            "烟台": "101120501",
            "潍坊": "101120601",
            "济宁": "101120701",
            "泰安": "101120801",
            "威海": "101121301",
            "日照": "101121501",
            "临沂": "101120901",
            "德州": "101121401",
            "聊城": "101121701",
            "滨州": "101121101",
            "菏泽": "101121001",
        }
        self.city_coordinates = {
            "济南": (117.0000, 36.6750, 0),
            "青岛": (120.3833, 36.0667, 0),
            "淄博": (118.0500, 36.7833, 0),
            "枣庄": (117.5667, 34.8667, 0),
            "东营": (118.4833, 37.4500, 0),
            "烟台": (121.4000, 37.5333, 0),
            "潍坊": (119.1000, 36.7167, 0),
            "济宁": (116.5833, 35.4000, 0),
            "泰安": (117.0833, 36.1833, 50),
            "威海": (122.1167, 37.5000, 0),
            "日照": (119.5333, 35.4167, 0),
            "临沂": (118.3500, 35.0500, 0),
            "德州": (116.3000, 37.4500, 0),
            "聊城": (115.9667, 36.4500, 0),
            "滨州": (118.0167, 37.3667, 0),
            "菏泽": (115.4333, 35.2333, 0)
        }
        self.shandong_terrain = self.generate_terrain_data()
        self.shandong_outline = [
            (115.5, 35.0), (116.0, 35.5), (116.5, 36.0), (117.0, 36.5),
            (117.5, 37.0), (118.0, 37.3), (118.5, 37.5), (119.0, 37.6),
            (119.5, 37.5), (120.0, 37.4), (120.5, 37.5), (121.0, 37.6),
            (121.5, 37.5), (122.0, 37.3), (122.5, 37.0), (122.3, 36.5),
            (122.0, 36.0), (121.5, 35.5), (121.0, 35.0), (120.5, 34.5),
            (119.5, 34.5), (118.5, 34.5), (117.5, 34.5), (116.5, 34.5),
            (115.5, 35.0),
        ]
        self.crops = {
            "番茄": {
                "发芽期": {"min_temp": 25, "max_temp": 30, "humidity": 70},
                "幼苗期": {"min_temp": 20, "max_temp": 25, "humidity": 65},
                "开花期": {"min_temp": 22, "max_temp": 28, "humidity": 60},
                "结果期": {"min_temp": 20, "max_temp": 26, "humidity": 55}
            },
            "黄瓜": {
                "发芽期": {"min_temp": 25, "max_temp": 30, "humidity": 80},
                "幼苗期": {"min_temp": 18, "max_temp": 25, "humidity": 75},
                "开花期": {"min_temp": 20, "max_temp": 28, "humidity": 70},
                "结果期": {"min_temp": 18, "max_temp": 26, "humidity": 65}
            },
            "辣椒": {
                "发芽期": {"min_temp": 25, "max_temp": 30, "humidity": 70},
                "幼苗期": {"min_temp": 20, "max_temp": 25, "humidity": 65},
                "开花期": {"min_temp": 22, "max_temp": 28, "humidity": 60},
                "结果期": {"min_temp": 20, "max_temp": 26, "humidity": 55}
            },
            "草莓": {
                "发芽期": {"min_temp": 20, "max_temp": 25, "humidity": 75},
                "幼苗期": {"min_temp": 15, "max_temp": 22, "humidity": 70},
                "开花期": {"min_temp": 18, "max_temp": 25, "humidity": 65},
                "结果期": {"min_temp": 15, "max_temp": 22, "humidity": 60}
            },
            "甜瓜": {
                "发芽期": {"min_temp": 25, "max_temp": 32, "humidity": 75},
                "幼苗期": {"min_temp": 20, "max_temp": 28, "humidity": 70},
                "开花期": {"min_temp": 22, "max_temp": 30, "humidity": 65},
                "结果期": {"min_temp": 20, "max_temp": 28, "humidity": 60}
            }
        }
        self.disaster_types = {
            "暴雨": {
                "description": "连续强降雨，可能导致大棚内积水、作物根部缺氧",
                "solutions": [
                    "及时清理排水沟，确保排水畅通",
                    "加固大棚结构，防止大风暴雨破坏",
                    "雨后及时通风，降低棚内湿度",
                    "检查作物根部，如有腐烂及时处理",
                    "可喷施杀菌剂预防病害发生"
                ]
            },
            "大风": {
                "description": "强风天气，可能损坏大棚结构，影响作物生长",
                "solutions": [
                    "检查并加固大棚骨架和薄膜",
                    "及时关闭通风口，防止强风灌入",
                    "增加压膜线，加固棚膜",
                    "如风力过大，可考虑暂时揭膜保棚",
                    "风后检查作物受损情况并及时处理"
                ]
            },
            "低温寒潮": {
                "description": "气温骤降，可能造成作物冻害，生长停滞",
                "solutions": [
                    "增加覆盖物，如草帘、保温被等",
                    "启用加温设备，保持棚内温度",
                    "减少通风，保持棚内热量",
                    "可喷施防冻剂增强作物抗寒能力",
                    "寒潮过后逐步恢复通风，避免温度骤变"
                ]
            },
            "高温干旱": {
                "description": "持续高温少雨，可能导致作物萎蔫、生长受阻",
                "solutions": [
                    "适时浇水，避开中午高温时段",
                    "增加遮阳网，降低棚内温度",
                    "加强通风，促进空气流通",
                    "叶面喷水，降低叶面温度",
                    "可喷施叶面肥增强作物抗旱能力"
                ]
            },
            "冰雹": {
                "description": "冰雹天气，可能砸坏大棚和作物",
                "solutions": [
                    "如预报有冰雹，及时覆盖防护网",
                    "冰雹过后检查大棚损坏情况并及时修复",
                    "清理破损叶片，减少病害发生",
                    "喷施杀菌剂预防伤口感染",
                    "追施速效肥促进作物恢复生长"
                ]
            },
            "连续阴雨": {
                "description": "长时间阴雨天气，光照不足，湿度大，易发病害",
                "solutions": [
                    "及时清理棚膜，增加透光率",
                    "控制浇水，降低棚内湿度",
                    "加强病害监测，及时防治",
                    "可补光增温，改善生长环境",
                    "雨停后及时通风排湿"
                ]
            }
        }
        self.current_city = "济南"
        self.current_crop = "番茄"
        self.all_cities_data = {}
        self.map_canvas = None
        self.map_mode = tk.StringVar(value="temperature")
        self.threed_fig = None
        self.threed_canvas = None
        self.setup_ui()
        self.refresh_all_weather()
        self.initialize_device_control()

    def get_token(self):
        """获取访问令牌的函数，复用原有逻辑"""
        url = "http://api.nlecloud.com/Users/Login"
        p = {
            "Account": "19000000011",  # 请替换为你的实际账号
            "Password": "000000",  # 请替换
            "IsRememberMe": True
        }
        try:
            r = requests.post(url, json=p, timeout=10)
            r.raise_for_status()  # 抛出HTTP请求异常
            d = r.json()
            if d.get("Status") == 0 and d.get("ResultObj"):
                return d["ResultObj"]["AccessToken"]
            else:
                print(f"获取令牌失败：{d.get('Msg', '未知错误')}")
                return None
        except Exception as e:
            print(f"获取令牌异常：{str(e)}")
            return None

    def send_sanre_command(self, cmd_value):
        """
        下发sanre设备控制命令
        :param cmd_value: 命令值（1=打开，0=关闭）
        :return: 响应结果字典
        """
        if not self.access_token:
            self.access_token = self.get_token()
            if not self.access_token:
                return None

        url = "http://api.nlecloud.com/Cmds"
        # URL查询参数（deviceId必填，apiTag必填）
        params = {
            "deviceId": self.DEVICE_ID,
            "apiTag": self.SANRE_API_TAG
        }
        # 请求头（携带AccessToken认证）
        headers = {
            "AccessToken": self.access_token,
            "Content-Type": "application/json"
        }

        try:
            # 发送POST请求，命令值以JSON格式传入（符合API要求的自定义数据类型）
            r = requests.post(
                url=url,
                params=params,
                headers=headers,
                json=cmd_value,  # 命令值（1/0），自动序列化为JSON格式
                timeout=10
            )
            r.raise_for_status()  # 抛出HTTP请求异常（4xx/5xx错误）
            return r.json()  # 解析响应JSON
        except Exception as e:
            print(f"命令发送异常：{str(e)}")
            return None

    def initialize_device_control(self):
        """初始化设备控制功能"""
        # 获取初始令牌
        self.access_token = self.get_token()
        if self.access_token:
            print("设备控制功能已初始化")
        else:
            print("设备控制功能初始化失败")

    def toggle_sanre_device(self):
        """切换sanre设备状态"""
        # 确定新的状态值
        new_state = 1 if self.current_sanre_state == 0 else 0
        action = "打开" if new_state == 1 else "关闭"

        # 更新按钮状态为禁用，防止重复点击
        self.sanre_button.config(state="disabled")
        self.status_label.config(text=f"正在{action}设备...")

        # 发送命令
        response = self.send_sanre_command(new_state)

        # 处理响应
        if response:
            status_code = response.get("StatusCode", -1)
            msg = response.get("Msg", "未知响应")

            if status_code == 0:
                # 命令发送成功
                self.current_sanre_state = new_state
                self.update_sanre_button_state()
                self.status_label.config(text=f"设备{action}成功！命令ID：{response.get('ResultObj', '未知')}")
                messagebox.showinfo("成功", f"{action}sanre设备成功！")
            else:
                # 命令发送失败
                self.status_label.config(text=f"设备{action}失败：{msg}")
                messagebox.showerror("失败", f"{action}sanre设备失败：{msg}")
        else:
            # 请求异常
            self.status_label.config(text=f"设备{action}失败：请求异常")
            messagebox.showerror("失败", f"{action}sanre设备失败：请求发送异常")

        # 重新启用按钮
        self.sanre_button.config(state="normal")

    def update_sanre_button_state(self):
        """更新sanre按钮的显示状态"""
        if self.current_sanre_state == 1:
            self.sanre_button.config(text="关闭设备", style="Success.TButton")
        else:
            self.sanre_button.config(text="打开设备", style="Danger.TButton")

    def generate_terrain_data(self):
        """生成简化的山东地形数据"""
        terrain = {}

        # 生成网格地形数据
        lons = np.linspace(115.5, 122.5, 30)
        lats = np.linspace(34.5, 38.5, 30)

        # 创建基础地形 - 山东中部有泰山等山脉
        for lon in lons:
            for lat in lats:
                # 模拟泰山区域（泰安附近）
                if 116.8 <= lon <= 117.5 and 36.0 <= lat <= 36.5:
                    height = 100 + 50 * np.exp(-((lon - 117.1) ** 2 + (lat - 36.2) ** 2) * 10)
                # 模拟崂山区域（青岛附近）
                elif 120.3 <= lon <= 120.8 and 36.0 <= lat <= 36.3:
                    height = 50 + 30 * np.exp(-((lon - 120.5) ** 2 + (lat - 36.1) ** 2) * 15)
                # 模拟鲁中南山区
                elif 117.5 <= lon <= 118.5 and 35.0 <= lat <= 36.0:
                    height = 30 + 20 * np.exp(-((lon - 118.0) ** 2 + (lat - 35.5) ** 2) * 8)
                else:
                    height = 5 + 5 * np.sin(lon * 2) * np.cos(lat * 2)

                terrain[(lon, lat)] = max(0, height)

        return terrain

    def setup_ui(self):
        """设置用户界面"""
        self.setup_styles()

        main_frame = ttk.Frame(self.root, padding="10")
        main_frame.grid(row=0, column=0, sticky=(tk.W, tk.E, tk.N, tk.S))

        # 标题框架
        title_frame = ttk.Frame(main_frame)
        title_frame.grid(row=0, column=0, columnspan=3, pady=(0, 10), sticky=(tk.W, tk.E))

        # 标题
        title_label = ttk.Label(title_frame, text="全省各地市气候可视化系统 - 大棚农作物发育期检测",
                                font=("Arial", 18, "bold"))
        title_label.grid(row=0, column=0, pady=10)

        # 副标题
        subtitle_label = ttk.Label(title_frame, text="实时气候监测与农作物发育期分析",
                                   font=("Arial", 12))
        subtitle_label.grid(row=1, column=0, pady=(0, 10))

        # 控制面板
        control_frame = ttk.LabelFrame(main_frame, text="控制面板", padding="10")
        control_frame.grid(row=1, column=0, columnspan=3, pady=(0, 10), sticky=(tk.W, tk.E))

        # 城市选择
        ttk.Label(control_frame, text="选择城市:", font=("Arial", 10)).grid(row=0, column=0, padx=(0, 5))

        self.city_var = tk.StringVar(value=self.current_city)
        city_combo = ttk.Combobox(control_frame, textvariable=self.city_var,
                                  values=list(self.shandong_cities.keys()),
                                  state="readonly", width=12, font=("Arial", 10))
        city_combo.grid(row=0, column=1, padx=(0, 15))
        city_combo.bind('<<ComboboxSelected>>', self.on_city_changed)

        # 农作物选择
        ttk.Label(control_frame, text="选择农作物:", font=("Arial", 10)).grid(row=0, column=2, padx=(0, 5))

        self.crop_var = tk.StringVar(value=self.current_crop)
        crop_combo = ttk.Combobox(control_frame, textvariable=self.crop_var,
                                  values=list(self.crops.keys()),
                                  state="readonly", width=12, font=("Arial", 10))
        crop_combo.grid(row=0, column=3, padx=(0, 15))
        crop_combo.bind('<<ComboboxSelected>>', self.on_crop_changed)

        # 时间显示
        self.time_label = ttk.Label(control_frame, text="", font=("Arial", 9))
        self.time_label.grid(row=0, column=4, padx=(15, 0))

        # 刷新按钮
        refresh_btn = ttk.Button(control_frame, text="刷新数据",
                                 command=self.refresh_all_weather)
        refresh_btn.grid(row=0, column=5, padx=(15, 0))

        # 自动刷新选项
        self.auto_refresh = tk.BooleanVar(value=False)
        auto_refresh_cb = ttk.Checkbutton(control_frame, text="自动刷新 (5分钟)",
                                          variable=self.auto_refresh,
                                          command=self.toggle_auto_refresh)
        auto_refresh_cb.grid(row=0, column=6, padx=(15, 0))

        # 模拟灾害按钮
        disaster_btn = ttk.Button(control_frame, text="模拟灾害天气",
                                  command=self.simulate_disaster_weather,
                                  style="Accent.TButton")
        disaster_btn.grid(row=0, column=7, padx=(15, 0))

        # 生成网页按钮
        web_btn = ttk.Button(control_frame, text="生成网页报告",
                             command=self.generate_web_report)
        web_btn.grid(row=0, column=8, padx=(15, 0))

        # 设备控制按钮
        self.sanre_button = ttk.Button(control_frame, text="打开设备",
                                       command=self.toggle_sanre_device,
                                       style="Danger.TButton")
        self.sanre_button.grid(row=0, column=9, padx=(15, 0))

        # 设备状态标签
        self.status_label = ttk.Label(control_frame, text="设备状态：未连接",
                                      font=("Arial", 9), foreground="gray")
        self.status_label.grid(row=0, column=10, padx=(15, 0))

        # 创建笔记本（选项卡）- 合并了当前天气和数据可视化
        self.notebook = ttk.Notebook(main_frame)
        self.notebook.grid(row=2, column=0, columnspan=3, sticky=(tk.W, tk.E, tk.N, tk.S))

        # 合并的天气与可视化标签页
        self.weather_viz_tab = ttk.Frame(self.notebook, padding="10")
        self.notebook.add(self.weather_viz_tab, text="天气与可视化")

        # 山东天气地图标签页
        self.map_tab = ttk.Frame(self.notebook, padding="10")
        self.notebook.add(self.map_tab, text="全省天气地图")

        # 3D山东地图标签页
        self.threed_tab = ttk.Frame(self.notebook, padding="10")
        self.notebook.add(self.threed_tab, text="3D地图")

        # 农作物发育期检测标签页
        self.crop_tab = ttk.Frame(self.notebook, padding="10")
        self.notebook.add(self.crop_tab, text="农作物发育期检测")

        # 设备控制标签页
        self.device_tab = ttk.Frame(self.notebook, padding="10")
        self.notebook.add(self.device_tab, text="设备控制")

        # 设置各个标签页
        self.setup_map_tab()
        self.setup_3d_map_tab()
        self.setup_device_tab()

        # 配置网格权重
        self.root.columnconfigure(0, weight=1)
        self.root.rowconfigure(0, weight=1)
        main_frame.columnconfigure(0, weight=1)
        main_frame.rowconfigure(2, weight=1)
        control_frame.columnconfigure(4, weight=1)

    def setup_styles(self):
        """设置自定义样式"""
        style = ttk.Style()
        style.theme_use('clam')

        # 为灾害按钮设置醒目的样式
        style.configure("Accent.TButton",
                        foreground="white",
                        background="#e74c3c",
                        font=("Arial", 10, "bold"))

        # 为设备控制按钮设置样式
        style.configure("Success.TButton",
                        foreground="white",
                        background="#27ae60",
                        font=("Arial", 10, "bold"))

        style.configure("Danger.TButton",
                        foreground="white",
                        background="#e74c3c",
                        font=("Arial", 10, "bold"))

    def setup_device_tab(self):
        """设置设备控制标签页"""
        for widget in self.device_tab.winfo_children():
            widget.destroy()

        device_frame = ttk.Frame(self.device_tab)
        device_frame.grid(row=0, column=0, sticky=(tk.W, tk.E, tk.N, tk.S), padx=10, pady=10)

        # 标题
        title_label = ttk.Label(device_frame, text="大棚设备远程控制系统",
                                font=("Arial", 18, "bold"))
        title_label.grid(row=0, column=0, columnspan=2, pady=(0, 20))

        # 设备信息框架
        info_frame = ttk.LabelFrame(device_frame, text="设备信息", padding="15")
        info_frame.grid(row=1, column=0, columnspan=2, sticky=(tk.W, tk.E), pady=(0, 20))

        ttk.Label(info_frame, text="设备ID:", font=("Arial", 11, "bold")).grid(row=0, column=0, sticky=tk.W, padx=(0, 10))
        ttk.Label(info_frame, text=str(self.DEVICE_ID), font=("Arial", 11)).grid(row=0, column=1, sticky=tk.W)

        ttk.Label(info_frame, text="API标识:", font=("Arial", 11, "bold")).grid(row=1, column=0, sticky=tk.W,
                                                                              padx=(0, 10))
        ttk.Label(info_frame, text=self.SANRE_API_TAG, font=("Arial", 11)).grid(row=1, column=1, sticky=tk.W)

        ttk.Label(info_frame, text="当前状态:", font=("Arial", 11, "bold")).grid(row=2, column=0, sticky=tk.W, padx=(0, 10))
        self.device_status_label = ttk.Label(info_frame, text="未知", font=("Arial", 11))
        self.device_status_label.grid(row=2, column=1, sticky=tk.W)

        # 控制按钮框架
        control_frame = ttk.LabelFrame(device_frame, text="设备控制", padding="15")
        control_frame.grid(row=2, column=0, columnspan=2, sticky=(tk.W, tk.E), pady=(0, 20))

        # 大控制按钮
        self.big_sanre_button = ttk.Button(control_frame, text="打开设备",
                                           command=self.toggle_sanre_device,
                                           style="Danger.TButton",
                                           width=20)
        self.big_sanre_button.grid(row=0, column=0, pady=10)

        # 状态指示
        status_indicator = ttk.Frame(control_frame, relief="solid", width=100, height=100)
        status_indicator.grid(row=0, column=1, padx=20, pady=10)
        status_indicator.grid_propagate(False)

        self.status_canvas = tk.Canvas(status_indicator, width=100, height=100, highlightthickness=0)
        self.status_canvas.grid(row=0, column=0, sticky="nsew")
        self.draw_status_indicator()

        # 操作说明
        help_frame = ttk.LabelFrame(device_frame, text="使用说明", padding="15")
        help_frame.grid(row=3, column=0, columnspan=2, sticky=(tk.W, tk.E))

        help_text = """
        • 点击"打开设备"按钮将开启大棚相关设备
        • 点击"关闭设备"按钮将关闭大棚相关设备
        • 设备状态指示灯会显示当前设备状态：
          - 红色：设备关闭
          - 绿色：设备开启
        • 操作结果会显示在状态栏和控制面板中
        • 如果设备控制失败，请检查网络连接和设备状态
        """

        help_label = ttk.Label(help_frame, text=help_text, font=("Arial", 10), justify="left")
        help_label.grid(row=0, column=0, sticky=tk.W)

        # 配置权重
        self.device_tab.columnconfigure(0, weight=1)
        self.device_tab.rowconfigure(0, weight=1)
        device_frame.columnconfigure(0, weight=1)
        device_frame.rowconfigure(3, weight=1)

        # 更新设备状态显示
        self.update_device_display()

    def draw_status_indicator(self):
        """绘制设备状态指示灯"""
        self.status_canvas.delete("all")

        if self.current_sanre_state == 1:
            # 设备开启 - 绿色
            color = "#27ae60"
            text = "设备开启"
        else:
            # 设备关闭 - 红色
            color = "#e74c3c"
            text = "设备关闭"

        # 绘制指示灯
        self.status_canvas.create_oval(20, 20, 80, 80, fill=color, outline="black", width=2)

        # 绘制文字
        self.status_canvas.create_text(50, 90, text=text, font=("Arial", 10, "bold"))

    def update_device_display(self):
        """更新设备显示状态"""
        # 更新大按钮
        if self.current_sanre_state == 1:
            self.big_sanre_button.config(text="关闭设备", style="Success.TButton")
            self.device_status_label.config(text="设备已开启")
        else:
            self.big_sanre_button.config(text="打开设备", style="Danger.TButton")
            self.device_status_label.config(text="设备已关闭")

        # 更新指示灯
        self.draw_status_indicator()

    def setup_3d_map_tab(self):
        """设置3D山东地图标签页"""
        for widget in self.threed_tab.winfo_children():
            widget.destroy()

        threed_frame = ttk.Frame(self.threed_tab)
        threed_frame.grid(row=0, column=0, sticky=(tk.W, tk.E, tk.N, tk.S))

        # 控制面板
        control_frame = ttk.Frame(threed_frame)
        control_frame.grid(row=0, column=0, sticky=(tk.W, tk.E), pady=(0, 10))

        ttk.Label(control_frame, text="3D地图显示模式:", font=("Arial", 10)).grid(row=0, column=0, padx=(0, 10))

        self.threed_mode = tk.StringVar(value="terrain")
        modes = [("地形图", "terrain"), ("温度分布", "temperature"), ("农作物适宜度", "crop_suitability")]

        for i, (text, mode) in enumerate(modes):
            rb = ttk.Radiobutton(control_frame, text=text, variable=self.threed_mode,
                                 value=mode, command=self.refresh_3d_map)
            rb.grid(row=0, column=i + 1, padx=(0, 20))

        # 创建3D地图画布
        canvas_frame = ttk.Frame(threed_frame)
        canvas_frame.grid(row=1, column=0, sticky=(tk.W, tk.E, tk.N, tk.S))

        # 创建图形和3D轴
        self.threed_fig = plt.figure(figsize=(10, 8), facecolor='white')
        self.threed_ax = self.threed_fig.add_subplot(111, projection='3d')

        # 创建画布
        self.threed_canvas = FigureCanvasTkAgg(self.threed_fig, canvas_frame)
        self.threed_canvas.get_tk_widget().grid(row=0, column=0, sticky=(tk.W, tk.E, tk.N, tk.S))
        # 配置权重
        self.threed_tab.columnconfigure(0, weight=1)
        self.threed_tab.rowconfigure(1, weight=1)
        threed_frame.columnconfigure(0, weight=1)
        threed_frame.rowconfigure(1, weight=1)
        canvas_frame.columnconfigure(0, weight=1)
        canvas_frame.rowconfigure(0, weight=1)

        # 初始绘制
        self.refresh_3d_map()

    def on_city_changed(self, event):
        """城市选择改变事件"""
        self.current_city = self.city_var.get()
        self.refresh_current_city_weather()

    def on_crop_changed(self, event):
        """农作物选择改变事件"""
        self.current_crop = self.crop_var.get()
        if hasattr(self, 'crop_tab'):
            self.setup_crop_development_tab()
        if hasattr(self, 'map_canvas') and self.map_canvas:
            self.refresh_map()
        if hasattr(self, 'threed_canvas') and self.threed_canvas:
            self.refresh_3d_map()

    def toggle_auto_refresh(self):
        """切换自动刷新"""
        if self.auto_refresh.get():
            self.schedule_auto_refresh()
        else:
            if hasattr(self, 'auto_refresh_id'):
                self.root.after_cancel(self.auto_refresh_id)

    def schedule_auto_refresh(self):
        """安排自动刷新"""
        if self.auto_refresh.get():
            self.refresh_all_weather()
            self.auto_refresh_id = self.root.after(300000, self.schedule_auto_refresh)  # 5分钟

    def setup_weather_viz_tab(self, weather_data):
        """设置合并的天气与可视化标签页"""
        for widget in self.weather_viz_tab.winfo_children():
            widget.destroy()

        if not weather_data:
            self.show_no_data_message(self.weather_viz_tab)
            return

        # 创建主框架
        main_frame = ttk.Frame(self.weather_viz_tab)
        main_frame.grid(row=0, column=0, sticky=(tk.W, tk.E, tk.N, tk.S), padx=10, pady=10)

        # 创建顶部框架用于显示天气信息
        top_frame = ttk.Frame(main_frame)
        top_frame.grid(row=0, column=0, columnspan=2, pady=(0, 20), sticky=(tk.W, tk.E))

        # 显示当前天气信息
        self.setup_current_weather_section(top_frame, weather_data)

        # 创建底部框架用于显示可视化图表
        bottom_frame = ttk.Frame(main_frame)
        bottom_frame.grid(row=1, column=0, columnspan=2, sticky=(tk.W, tk.E, tk.N, tk.S))

        # 显示可视化图表
        self.create_weather_charts(bottom_frame, weather_data)

        # 配置权重
        self.weather_viz_tab.columnconfigure(0, weight=1)
        self.weather_viz_tab.rowconfigure(0, weight=1)
        main_frame.columnconfigure(0, weight=1)
        main_frame.rowconfigure(1, weight=1)
        bottom_frame.columnconfigure(0, weight=1)
        bottom_frame.rowconfigure(0, weight=1)

    def setup_current_weather_section(self, parent, weather_data):
        """设置当前天气信息部分"""
        city_label = ttk.Label(parent, text=f"{self.current_city}天气",
                               font=("Arial", 20, "bold"))
        city_label.grid(row=0, column=0, columnspan=2, pady=(20, 10))

        weather_icon = self.get_weather_icon(weather_data.get('text', ''))
        icon_label = ttk.Label(parent, text=weather_icon, font=("Arial", 64))
        icon_label.grid(row=1, column=0, rowspan=2, padx=(30, 20))

        temp_frame = ttk.Frame(parent)
        temp_frame.grid(row=1, column=1, sticky=tk.W)

        temp_label = ttk.Label(temp_frame, text=f"{weather_data.get('temp', 'N/A')}°C",
                               font=("Arial", 42, "bold"))
        temp_label.grid(row=0, column=0, sticky=tk.W)

        weather_text = ttk.Label(temp_frame, text=weather_data.get('text', 'N/A'),
                                 font=("Arial", 18))
        weather_text.grid(row=1, column=0, sticky=tk.W)

        feels_like = ttk.Label(temp_frame,
                               text=f"体感温度: {weather_data.get('feelsLike', 'N/A')}°C",
                               font=("Arial", 14))
        feels_like.grid(row=2, column=0, sticky=tk.W, pady=(5, 0))

        # 天气指标卡片
        indices_frame = ttk.Frame(parent)
        indices_frame.grid(row=3, column=0, columnspan=2, pady=(20, 0), sticky=(tk.W, tk.E))

        indices = [
            ("风速", f"{weather_data.get('windSpeed', 'N/A')} km/h", "#4299e1"),
            ("风力", f"{weather_data.get('windScale', 'N/A')}级", "#48bb78"),
            ("湿度", f"{weather_data.get('humidity', 'N/A')}%", "#38b2ac"),
            ("降水", f"{weather_data.get('precip', 'N/A')} mm", "#4a6fa5"),
            ("气压", f"{weather_data.get('pressure', 'N/A')} hPa", "#805ad5"),
            ("能见度", f"{weather_data.get('vis', 'N/A')} km", "#ed8936"),
        ]

        for i, (label, value, color) in enumerate(indices):
            card = ttk.Frame(indices_frame, relief="raised", padding=5)
            card.grid(row=0, column=i, padx=5, pady=5, sticky=(tk.W, tk.E))

            ttk.Label(card, text=label, font=("Arial", 10)).grid(row=0, column=0, sticky=tk.W)
            ttk.Label(card, text=value, font=("Arial", 14, "bold")).grid(row=1, column=0, sticky=tk.W)

        parent.columnconfigure(1, weight=1)
        for i in range(6):
            indices_frame.columnconfigure(i, weight=1)

    def setup_map_tab(self):
        """设置山东天气地图标签页"""
        for widget in self.map_tab.winfo_children():
            widget.destroy()

        map_frame = ttk.Frame(self.map_tab)
        map_frame.grid(row=0, column=0, sticky=(tk.W, tk.E, tk.N, tk.S))

        control_frame = ttk.Frame(map_frame)
        control_frame.grid(row=0, column=0, sticky=(tk.W, tk.E), pady=(0, 10))

        ttk.Label(control_frame, text="地图显示模式:", font=("Arial", 10)).grid(row=0, column=0, padx=(0, 10))

        modes = [("温度分布", "temperature"), ("农作物适宜度", "crop_suitability")]

        for i, (text, mode) in enumerate(modes):
            rb = ttk.Radiobutton(control_frame, text=text, variable=self.map_mode,
                                 value=mode, command=self.refresh_map)
            rb.grid(row=0, column=i + 1, padx=(0, 20))

        canvas_frame = ttk.Frame(map_frame)
        canvas_frame.grid(row=1, column=0, sticky=(tk.W, tk.E, tk.N, tk.S))

        self.map_canvas = tk.Canvas(canvas_frame, width=1000, height=700, bg="#e8f4fd")
        self.map_canvas.grid(row=0, column=0, sticky=(tk.W, tk.E, tk.N, tk.S))

        v_scrollbar = ttk.Scrollbar(canvas_frame, orient=tk.VERTICAL, command=self.map_canvas.yview)
        h_scrollbar = ttk.Scrollbar(canvas_frame, orient=tk.HORIZONTAL, command=self.map_canvas.xview)
        self.map_canvas.configure(yscrollcommand=v_scrollbar.set, xscrollcommand=h_scrollbar.set)

        v_scrollbar.grid(row=0, column=1, sticky=(tk.N, tk.S))
        h_scrollbar.grid(row=1, column=0, sticky=(tk.W, tk.E))

        self.map_tab.columnconfigure(0, weight=1)
        self.map_tab.rowconfigure(1, weight=1)
        map_frame.columnconfigure(0, weight=1)
        map_frame.rowconfigure(1, weight=1)
        canvas_frame.columnconfigure(0, weight=1)
        canvas_frame.rowconfigure(0, weight=1)

        self.refresh_map()

    def setup_crop_development_tab(self):
        """设置农作物发育期检测标签页"""
        for widget in self.crop_tab.winfo_children():
            widget.destroy()

        crop_frame = ttk.Frame(self.crop_tab)
        crop_frame.grid(row=0, column=0, sticky=(tk.W, tk.E, tk.N, tk.S))

        title_label = ttk.Label(crop_frame,
                                text=f"{self.current_crop} - 发育期适宜性分析",
                                font=("Arial", 16, "bold"))
        title_label.grid(row=0, column=0, columnspan=3, pady=(0, 20))

        self.create_crop_development_analysis(crop_frame)

        self.crop_tab.columnconfigure(0, weight=1)
        self.crop_tab.rowconfigure(0, weight=1)
        crop_frame.columnconfigure(0, weight=1)
        crop_frame.rowconfigure(1, weight=1)

    def create_crop_development_analysis(self, parent):
        """创建农作物发育期分析内容"""
        analysis_notebook = ttk.Notebook(parent)
        analysis_notebook.grid(row=1, column=0, sticky=(tk.W, tk.E, tk.N, tk.S))

        for city_name in self.shandong_cities.keys():
            city_frame = ttk.Frame(analysis_notebook, padding="10")
            analysis_notebook.add(city_frame, text=city_name)

            self.create_city_crop_analysis(city_frame, city_name)

        parent.columnconfigure(0, weight=1)
        parent.rowconfigure(1, weight=1)

    def create_city_crop_analysis(self, parent, city_name):
        """创建单个城市的农作物分析"""
        for widget in parent.winfo_children():
            widget.destroy()

        if city_name not in self.all_cities_data or not self.all_cities_data[city_name]:
            no_data_label = ttk.Label(parent, text=f"暂无{city_name}的天气数据",
                                      font=("Arial", 14))
            no_data_label.grid(row=0, column=0, pady=50)
            return

        weather_data = self.all_cities_data[city_name].get("now", {})
        if not weather_data:
            no_data_label = ttk.Label(parent, text=f"{city_name}天气数据不完整",
                                      font=("Arial", 14))
            no_data_label.grid(row=0, column=0, pady=50)
            return

        try:
            current_temp = float(weather_data.get('temp', 0))
            current_humidity = float(weather_data.get('humidity', 0))
        except (ValueError, TypeError):
            current_temp = 0
            current_humidity = 0

        analysis_frame = ttk.LabelFrame(parent, text="发育期适宜性分析", padding="10")
        analysis_frame.grid(row=0, column=0, sticky=(tk.W, tk.E, tk.N, tk.S), pady=(0, 10))

        columns = ("发育期", "适宜温度", "当前温度", "温度适宜度", "适宜湿度", "当前湿度", "湿度适宜度", "综合评分")
        tree = ttk.Treeview(analysis_frame, columns=columns, show="headings", height=6)

        for col in columns:
            tree.heading(col, text=col)
            tree.column(col, width=100, anchor="center")

        crop_data = self.crops[self.current_crop]
        for stage, params in crop_data.items():
            min_temp = params["min_temp"]
            max_temp = params["max_temp"]
            ideal_humidity = params["humidity"]

            temp_suitability = self.calculate_suitability(current_temp, min_temp, max_temp)
            humidity_suitability = self.calculate_humidity_suitability(current_humidity, ideal_humidity)
            overall_score = (temp_suitability + humidity_suitability) / 2

            tree.insert("", "end", values=(
                stage,
                f"{min_temp}-{max_temp}°C",
                f"{current_temp}°C",
                f"{temp_suitability:.1f}%",
                f"{ideal_humidity}%",
                f"{current_humidity}%",
                f"{humidity_suitability:.1f}%",
                f"{overall_score:.1f}%"
            ))

        tree.grid(row=0, column=0, sticky=(tk.W, tk.E, tk.N, tk.S))

        advice_frame = ttk.LabelFrame(parent, text="种植建议", padding="10")
        advice_frame.grid(row=1, column=0, sticky=(tk.W, tk.E), pady=(10, 0))

        best_stage = self.get_best_development_stage(crop_data, current_temp, current_humidity)
        advice_text = f"当前最适宜发育期: {best_stage}\n建议措施: {self.get_growing_advice(best_stage)}"

        advice_label = ttk.Label(advice_frame, text=advice_text, font=("Arial", 11))
        advice_label.grid(row=0, column=0, sticky=tk.W)

        parent.columnconfigure(0, weight=1)
        parent.rowconfigure(0, weight=1)
        analysis_frame.columnconfigure(0, weight=1)
        analysis_frame.rowconfigure(0, weight=1)
        advice_frame.columnconfigure(0, weight=1)

    def calculate_suitability(self, current_temp, min_temp, max_temp):
        """计算温度适宜度"""
        try:
            if current_temp < min_temp:
                suitability = max(0, 100 * (1 - (min_temp - current_temp) / 10))
            elif current_temp > max_temp:
                suitability = max(0, 100 * (1 - (current_temp - max_temp) / 10))
            else:
                ideal_range = (min_temp + max_temp) / 2
                tolerance = (max_temp - min_temp) / 2
                deviation = abs(current_temp - ideal_range) / tolerance
                suitability = 100 * (1 - deviation * 0.5)

            return max(0, min(100, suitability))
        except:
            return 0

    def calculate_humidity_suitability(self, current_humidity, ideal_humidity):
        """计算湿度适宜度"""
        try:
            deviation = abs(current_humidity - ideal_humidity) / 20
            suitability = 100 * (1 - deviation)
            return max(0, min(100, suitability))
        except:
            return 0

    def get_best_development_stage(self, crop_data, current_temp, current_humidity):
        """获取最佳发育期"""
        best_stage = "未知"
        best_score = -1

        for stage, params in crop_data.items():
            min_temp = params["min_temp"]
            max_temp = params["max_temp"]
            ideal_humidity = params["humidity"]

            temp_score = self.calculate_suitability(current_temp, min_temp, max_temp)
            humidity_score = self.calculate_humidity_suitability(current_humidity, ideal_humidity)
            overall_score = (temp_score + humidity_score) / 2

            if overall_score > best_score:
                best_score = overall_score
                best_stage = stage

        return best_stage

    def get_growing_advice(self, stage):
        """根据发育期获取种植建议"""
        advice_map = {
            "发芽期": "保持土壤湿润，提供充足光照",
            "幼苗期": "适当控水，加强通风，预防病害",
            "开花期": "保证水分供应，适当追肥",
            "结果期": "加强水肥管理，及时采收"
        }
        return advice_map.get(stage, "根据具体生长情况调整管理措施")

    def refresh_3d_map(self):
        """刷新3D地图"""
        if not hasattr(self, 'threed_ax') or not self.threed_ax:
            return

        self.threed_ax.clear()

        mode = self.threed_mode.get()

        if mode == "terrain":
            self.draw_3d_terrain()
        elif mode == "temperature":
            self.draw_3d_temperature()
        else:
            self.draw_3d_crop_suitability()

        self.threed_ax.set_xlabel('经度')
        self.threed_ax.set_ylabel('纬度')
        self.threed_ax.set_zlabel('高度/数值')

        # 设置视角
        self.threed_ax.view_init(elev=30, azim=45)

        self.threed_canvas.draw()

    def draw_3d_terrain(self):
        """绘制3D地形图"""
        # 提取地形数据
        lons = []
        lats = []
        heights = []

        for (lon, lat), height in self.shandong_terrain.items():
            lons.append(lon)
            lats.append(lat)
            heights.append(height)

        # 创建网格
        unique_lons = sorted(set(lons))
        unique_lats = sorted(set(lats))
        lon_grid, lat_grid = np.meshgrid(unique_lons, unique_lats)
        height_grid = np.zeros_like(lon_grid)

        # 填充高度数据
        for i, lon in enumerate(unique_lons):
            for j, lat in enumerate(unique_lats):
                height_grid[j, i] = self.shandong_terrain.get((lon, lat), 0)

        # 绘制地形表面
        surf = self.threed_ax.plot_surface(lon_grid, lat_grid, height_grid,
                                           cmap='terrain', alpha=0.7,
                                           linewidth=0, antialiased=True)

        # 添加颜色条
        self.threed_fig.colorbar(surf, ax=self.threed_ax, shrink=0.5, aspect=5, label='高度 (米)')

        # 添加城市标记
        for city, (lon, lat, base_height) in self.city_coordinates.items():
            height = self.shandong_terrain.get((lon, lat), base_height)
            self.threed_ax.scatter(lon, lat, height + 5, color='red', s=50, marker='o')
            self.threed_ax.text(lon, lat, height + 10, city, fontsize=8, ha='center')

        self.threed_ax.set_title('3D地形图')

    def draw_3d_temperature(self):
        """绘制3D温度分布图"""
        # 绘制基础地形
        self.draw_3d_terrain_base()

        # 添加温度柱状图
        for city, (lon, lat, base_height) in self.city_coordinates.items():
            if city in self.all_cities_data:
                data = self.all_cities_data[city]
                if data and "now" in data:
                    now_data = data["now"]
                    temp = now_data.get('temp', 'N/A')

                    if temp != 'N/A':
                        try:
                            temp_val = float(temp)
                            # 地形高度
                            terrain_height = self.shandong_terrain.get((lon, lat), base_height)
                            # 温度柱高度 (将温度映射到合理的高度范围)
                            temp_height = temp_val * 10  # 放大温度值以便在3D中显示

                            color = self.get_temperature_color(temp_val)

                            # 绘制温度柱
                            self.threed_ax.bar3d(lon - 0.1, lat - 0.1, terrain_height,
                                                 0.2, 0.2, temp_height,
                                                 color=color, alpha=0.8)

                            # 添加城市标签
                            self.threed_ax.text(lon, lat, terrain_height + temp_height + 20,
                                                f"{city}\n{temp}°C",
                                                fontsize=8, ha='center')
                        except ValueError:
                            continue

        self.threed_ax.set_title('3D温度分布图')

    def draw_3d_crop_suitability(self):
        """绘制3D农作物适宜度分布图"""
        # 绘制基础地形
        self.draw_3d_terrain_base()

        # 添加适宜度柱状图
        for city, (lon, lat, base_height) in self.city_coordinates.items():
            if city in self.all_cities_data:
                data = self.all_cities_data[city]
                if data and "now" in data:
                    now_data = data["now"]
                    try:
                        temp = float(now_data.get('temp', 0))
                        humidity = float(now_data.get('humidity', 0))
                    except (ValueError, TypeError):
                        continue

                    # 计算适宜度
                    suitability = self.calculate_crop_suitability(temp, humidity)
                    # 地形高度
                    terrain_height = self.shandong_terrain.get((lon, lat), base_height)
                    # 适宜度柱高度
                    suit_height = suitability * 2  # 放大适宜度值

                    color = self.get_suitability_color(suitability)

                    # 绘制适宜度柱
                    self.threed_ax.bar3d(lon - 0.1, lat - 0.1, terrain_height,
                                         0.2, 0.2, suit_height,
                                         color=color, alpha=0.8)

                    # 添加城市标签
                    self.threed_ax.text(lon, lat, terrain_height + suit_height + 20,
                                        f"{city}\n{suitability:.0f}%",
                                        fontsize=8, ha='center')

        self.threed_ax.set_title(f'3D{self.current_crop}适宜度分布图')

    def draw_3d_terrain_base(self):
        """绘制3D地形基础（不带颜色条）"""
        lons = []
        lats = []
        heights = []

        for (lon, lat), height in self.shandong_terrain.items():
            lons.append(lon)
            lats.append(lat)
            heights.append(height)

        unique_lons = sorted(set(lons))
        unique_lats = sorted(set(lats))
        lon_grid, lat_grid = np.meshgrid(unique_lons, unique_lats)
        height_grid = np.zeros_like(lon_grid)

        for i, lon in enumerate(unique_lons):
            for j, lat in enumerate(unique_lats):
                height_grid[j, i] = self.shandong_terrain.get((lon, lat), 0)

        self.threed_ax.plot_surface(lon_grid, lat_grid, height_grid,
                                    cmap='terrain', alpha=0.3,
                                    linewidth=0, antialiased=True)

    def refresh_map(self):
        """刷新地图显示"""
        if not hasattr(self, 'map_canvas') or not self.map_canvas:
            return

        self.map_canvas.delete("all")

        if not self.all_cities_data:
            self.map_canvas.create_text(500, 350, text="正在加载天气数据...",
                                        font=("Arial", 16), fill="#666")
            return

        self.draw_shandong_map()

        if self.map_mode.get() == "temperature":
            self.draw_temperature_points()
        else:
            self.draw_crop_suitability_points()

        self.draw_legend()

    def draw_shandong_map(self):
        """绘制山东地图轮廓"""
        canvas_points = []
        for lon, lat in self.shandong_outline:
            x, y = self.geo_to_canvas(lon, lat)
            canvas_points.extend([x, y])

        self.map_canvas.create_polygon(canvas_points, fill="#a0c8f0", outline="#2c5282", width=2, smooth=True)

        self.draw_city_connections()

    def draw_city_connections(self):
        """绘制城市间的主要连接线"""
        connections = [
            ("济南", "淄博"), ("济南", "泰安"), ("济南", "德州"), ("济南", "聊城"),
            ("青岛", "潍坊"), ("青岛", "烟台"), ("青岛", "日照"),
            ("淄博", "潍坊"), ("淄博", "滨州"),
            ("潍坊", "烟台"), ("潍坊", "日照"), ("潍坊", "东营"),
            ("济宁", "泰安"), ("济宁", "枣庄"), ("济宁", "菏泽"),
            ("临沂", "枣庄"), ("临沂", "日照"), ("临沂", "潍坊")
        ]

        for city1, city2 in connections:
            if city1 in self.city_coordinates and city2 in self.city_coordinates:
                x1, y1 = self.geo_to_canvas(*self.city_coordinates[city1][:2])
                x2, y2 = self.geo_to_canvas(*self.city_coordinates[city2][:2])
                self.map_canvas.create_line(x1, y1, x2, y2, fill="#cbd5e0", width=1, dash=(4, 2))

    def draw_temperature_points(self):
        """绘制温度分布点"""
        for city_name, (lon, lat, _) in self.city_coordinates.items():
            if city_name in self.all_cities_data:
                data = self.all_cities_data[city_name]
                if data and "now" in data:
                    now_data = data["now"]
                    temp = now_data.get('temp', 'N/A')

                    x, y = self.geo_to_canvas(lon, lat)

                    if temp != 'N/A':
                        try:
                            temp_val = float(temp)
                            color = self.get_temperature_color(temp_val)

                            self.map_canvas.create_oval(x - 12, y - 12, x + 12, y + 12,
                                                        fill=color, outline="#2c5282", width=2)

                            self.map_canvas.create_text(x, y - 25, text=city_name,
                                                        font=("Arial", 10, "bold"), fill="#2c5282")
                            self.map_canvas.create_text(x, y + 25, text=f"{temp}°C",
                                                        font=("Arial", 10, "bold"), fill="#4a5568")
                        except ValueError:
                            continue

    def draw_crop_suitability_points(self):
        """绘制农作物适宜度点"""
        for city_name, (lon, lat, _) in self.city_coordinates.items():
            if city_name in self.all_cities_data:
                data = self.all_cities_data[city_name]
                if data and "now" in data:
                    now_data = data["now"]
                    try:
                        temp = float(now_data.get('temp', 0))
                        humidity = float(now_data.get('humidity', 0))
                    except (ValueError, TypeError):
                        continue

                    x, y = self.geo_to_canvas(lon, lat)

                    suitability = self.calculate_crop_suitability(temp, humidity)
                    color = self.get_suitability_color(suitability)

                    self.map_canvas.create_oval(x - 15, y - 15, x + 15, y + 15,
                                                fill=color, outline="#2c5282", width=2)

                    self.map_canvas.create_text(x, y - 30, text=city_name,
                                                font=("Arial", 10, "bold"), fill="#2c5282")
                    self.map_canvas.create_text(x, y + 30, text=f"{suitability:.0f}%",
                                                font=("Arial", 10, "bold"), fill="#4a5568")

    def geo_to_canvas(self, lon, lat):
        """将地理坐标转换为画布坐标"""
        min_lon, max_lon = 115.5, 122.0
        min_lat, max_lat = 34.5, 38.0
        canvas_width, canvas_height = 1000, 700
        margin = 50

        x_ratio = (canvas_width - 2 * margin) / (max_lon - min_lon)
        y_ratio = (canvas_height - 2 * margin) / (max_lat - min_lat)

        x = margin + (lon - min_lon) * x_ratio
        y = canvas_height - margin - (lat - min_lat) * y_ratio

        return x, y

    def calculate_crop_suitability(self, temp, humidity):
        """计算农作物综合适宜度"""
        crop_data = self.crops[self.current_crop]
        max_suitability = 0

        for stage, params in crop_data.items():
            min_temp = params["min_temp"]
            max_temp = params["max_temp"]
            ideal_humidity = params["humidity"]

            temp_score = self.calculate_suitability(temp, min_temp, max_temp)
            humidity_score = self.calculate_humidity_suitability(humidity, ideal_humidity)
            overall_score = (temp_score + humidity_score) / 2

            if overall_score > max_suitability:
                max_suitability = overall_score

        return max_suitability

    def draw_legend(self):
        """绘制图例"""
        if self.map_mode.get() == "temperature":
            self.draw_temperature_legend()
        else:
            self.draw_suitability_legend()

    def draw_temperature_legend(self):
        """绘制温度图例"""
        legend_x, legend_y = 50, 50
        self.map_canvas.create_rectangle(legend_x, legend_y, legend_x + 150, legend_y + 140,
                                         fill="white", outline="#cbd5e0", width=2)
        self.map_canvas.create_text(legend_x + 75, legend_y + 15, text="温度图例",
                                    font=("Arial", 11, "bold"), fill="#2d3748")

        temp_ranges = [
            ("较暖 7-10°C", "#ff6b6b", legend_y + 35),
            ("温和 4-7°C", "#ffa726", legend_y + 60),
            ("凉爽 2-4°C", "#4ecdc4", legend_y + 85),
            ("寒冷 0-2°C", "#45b7d1", legend_y + 110)
        ]

        for text, color, y_pos in temp_ranges:
            self.map_canvas.create_oval(legend_x + 10, y_pos - 8, legend_x + 20, y_pos + 2, fill=color)
            self.map_canvas.create_text(legend_x + 35, y_pos - 3, text=text,
                                        font=("Arial", 9), fill="#4a5568", anchor="w")

    def draw_suitability_legend(self):
        """绘制适宜度图例"""
        legend_x, legend_y = 50, 50
        self.map_canvas.create_rectangle(legend_x, legend_y, legend_x + 180, legend_y + 140,
                                         fill="white", outline="#cbd5e0", width=2)
        self.map_canvas.create_text(legend_x + 90, legend_y + 15, text=f"{self.current_crop}适宜度图例",
                                    font=("Arial", 11, "bold"), fill="#2d3748")

        suitability_ranges = [
            ("适宜 80-100%", "#48bb78", legend_y + 35),
            ("一般 60-80%", "#ecc94b", legend_y + 60),
            ("不适宜 40-60%", "#ed8936", legend_y + 85),
            ("很差 <40%", "#f56565", legend_y + 110)
        ]

        for text, color, y_pos in suitability_ranges:
            self.map_canvas.create_oval(legend_x + 10, y_pos - 8, legend_x + 20, y_pos + 2, fill=color)
            self.map_canvas.create_text(legend_x + 35, y_pos - 3, text=text,
                                        font=("Arial", 9), fill="#4a5568", anchor="w")

    def get_temperature_color(self, temp):
        """根据温度获取颜色"""
        if temp >= 7:
            return "#ff6b6b"
        elif temp >= 4:
            return "#ffa726"
        elif temp >= 2:
            return "#4ecdc4"
        else:
            return "#45b7d1"

    def get_suitability_color(self, suitability):
        """根据适宜度获取颜色"""
        if suitability >= 80:
            return "#48bb78"
        elif suitability >= 60:
            return "#ecc94b"
        elif suitability >= 40:
            return "#ed8936"
        else:
            return "#f56565"

    def create_weather_charts(self, parent, weather_data):
        """创建天气数据图表"""
        if not weather_data:
            self.show_no_data_message(parent)
            return

        try:
            fig, ((ax1, ax2), (ax3, ax4)) = plt.subplots(2, 2, figsize=(12, 8), facecolor='white')
            fig.suptitle(f'{self.current_city}天气数据可视化', fontsize=16, fontweight='bold')

            try:
                temp = float(weather_data.get('temp', 0))
                feels_like = float(weather_data.get('feelsLike', 0))
                humidity = float(weather_data.get('humidity', 0))
                wind_speed = float(weather_data.get('windSpeed', 0))
                pressure = float(weather_data.get('pressure', 0)) / 100
                wind_scale = float(weather_data.get('windScale', 0))
            except (ValueError, TypeError):
                temp = feels_like = humidity = wind_speed = pressure = wind_scale = 0

            categories = ['温度', '体感温度', '湿度', '风速', '气压']
            values = [temp, feels_like, humidity, wind_speed, pressure]
            colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7']

            for ax in [ax1, ax2, ax3, ax4]:
                ax.set_facecolor('white')
            ax1.set_ylim(0, 10)
            bars = ax1.bar(categories, values, color=colors, alpha=0.7)
            ax1.set_title('天气数据')
            ax1.tick_params(axis='x', rotation=45)
            ax1.grid(True, alpha=0.3)

            for bar, value in zip(bars, values):
                ax1.text(bar.get_x() + bar.get_width() / 2, bar.get_height() + 0.1,
                         f'{value:.1f}', ha='center', va='bottom', fontweight='bold')

            temp_labels = ['', '']
            temp_values = [temp, feels_like]
            ax2.pie(temp_values, labels=temp_labels, autopct='%1.1f°C',
                    colors=['#FF6B6B', '#4ECDC4'], startangle=90)
            ax2.set_title('总体差距')

            ax3.barh(['湿度'], [100], color='lightgray', alpha=0.3)
            ax3.barh(['湿度'], [humidity], color='#45B7D1', alpha=0.7)
            ax3.set_xlim(0, 100)
            ax3.set_title(f'湿度: {humidity}%')
            ax3.text(humidity, 0, f'{humidity}%', ha='center', va='center',
                     fontweight='bold', fontsize=16)

            wind_data = [wind_speed, wind_scale]
            wind_labels = ['风速(km/h)', '风力等级']
            ax4.bar(wind_labels, wind_data, color=['#96CEB4', '#FFEAA7'], alpha=0.7)
            ax4.set_title('风况信息')
            ax4.grid(True, alpha=0.3)

            plt.tight_layout()

            canvas = FigureCanvasTkAgg(fig, parent)
            canvas.draw()
            canvas.get_tk_widget().grid(row=0, column=0, sticky=(tk.W, tk.E, tk.N, tk.S))

        except Exception as e:
            error_label = ttk.Label(parent, text=f"创建图表时出错: {str(e)}",
                                    font=("Arial", 12), foreground="red")
            error_label.grid(row=0, column=0)

    def get_weather_icon(self, weather_text):
        icon_map = {
            '晴': '☀',
            '多云': '☁',
            '阴': '☁',
            '雨': '☂',
            '雪': '❄',
            '雾': '≡',
            '雷阵雨': '☈'
        }

        for key, value in icon_map.items():
            if key in weather_text:
                return value
        return '☀'

    def get_mock_weather_data(self, city_name):
        """生成模拟天气数据"""
        base_temp = {
            "济南": 5, "青岛": 6, "淄博": 5, "枣庄": 7, "东营": 4,
            "烟台": 5, "潍坊": 5, "济宁": 6, "泰安": 4, "威海": 5,
            "日照": 6, "临沂": 7, "德州": 4, "聊城": 5, "滨州": 4, "菏泽": 6
        }

        weather_types = ['晴', '多云', '阴', '小雨', '小雪']

        base_temp_val = base_temp.get(city_name, 5)
        temp = max(0, min(10, base_temp_val + random.uniform(-1, 1)))
        feels_like = max(0, min(10, temp + random.uniform(-0.5, 0.5)))
        humidity = random.randint(50, 85)
        wind_speed = random.uniform(5, 15)
        wind_scale = random.randint(1, 3)
        pressure = random.randint(1010, 1030)
        precip = random.uniform(0, 2)
        vis = random.uniform(8, 25)
        weather_text = random.choice(weather_types)

        return {
            "code": "200",
            "updateTime": datetime.now().strftime("%Y-%m-%dT%H:%M:%S+08:00"),
            "now": {
                "obsTime": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                "temp": f"{temp:.1f}",
                "feelsLike": f"{feels_like:.1f}",
                "text": weather_text,
                "windDir": "北风",
                "windScale": str(wind_scale),
                "windSpeed": f"{wind_speed:.1f}",
                "humidity": str(humidity),
                "precip": f"{precip:.1f}",
                "pressure": str(pressure),
                "vis": f"{vis:.1f}"
            }
        }

    def get_city_weather(self, location_id):
        """获取指定城市的天气数据"""
        if self.use_mock_data:
            city_name = [name for name, id in self.shandong_cities.items() if id == location_id][0]
            return self.get_mock_weather_data(city_name)

        url = f"https://devapi.qweather.com/v7/weather/now?location={location_id}&key=YOUR_API_KEY"

        try:
            response = requests.get(url, timeout=10)
            if response.status_code == 200:
                data = response.json()
                if data.get("code") == "200":
                    return data
            print(f"请求失败，状态码: {response.status_code}")
            city_name = [name for name, id in self.shandong_cities.items() if id == location_id][0]
            return self.get_mock_weather_data(city_name)
        except Exception as e:
            print(f"发生错误: {str(e)}")
            city_name = [name for name, id in self.shandong_cities.items() if id == location_id][0]
            return self.get_mock_weather_data(city_name)

    def refresh_all_weather(self):
        """刷新所有城市天气数据"""
        current_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        self.time_label.config(text=f"最后更新: {current_time}")

        for city_name, location_id in self.shandong_cities.items():
            weather_data = self.get_city_weather(location_id)
            if weather_data:
                self.all_cities_data[city_name] = weather_data

        self.refresh_current_city_weather()
        if hasattr(self, 'map_canvas') and self.map_canvas:
            self.refresh_map()
        if hasattr(self, 'threed_canvas') and self.threed_canvas:
            self.refresh_3d_map()
        self.setup_crop_development_tab()

    def refresh_current_city_weather(self):
        location_id = self.shandong_cities.get(self.current_city)
        if not location_id:
            self.show_error(f"未找到城市 {self.current_city} 的位置ID")
            return

        weather_data = self.get_city_weather(location_id)
        if not weather_data:
            self.show_error(f"无法获取 {self.current_city} 的天气数据")
            return

        if weather_data.get("code") == "200":
            now_data = weather_data.get("now", {})
            self.setup_weather_viz_tab(now_data)
        else:
            self.show_error(f"API返回错误: {weather_data.get('code', '未知错误')}")

    def show_no_data_message(self, parent):
        for widget in parent.winfo_children():
            widget.destroy()

        message_label = ttk.Label(parent, text="暂无天气数据",
                                  font=("Arial", 16), foreground="gray")
        message_label.grid(row=0, column=0, pady=50)

    def show_error(self, message):
        print(f"错误: {message}")

    # 以下是缺失的其他方法
    def simulate_disaster_weather(self):
        """模拟灾害天气并显示解决方案"""
        disaster_type = random.choice(list(self.disaster_types.keys()))
        disaster_info = self.disaster_types[disaster_type]
        self.create_disaster_solution_window(disaster_type, disaster_info)

    def create_disaster_solution_window(self, disaster_type, disaster_info):
        """创建灾害解决方案窗口"""
        disaster_window = tk.Toplevel(self.root)
        disaster_window.title(f"灾害天气预警 - {disaster_type}")
        disaster_window.geometry("600x500")
        disaster_window.configure(bg='#f8f9fa')
        disaster_window.transient(self.root)
        disaster_window.grab_set()

        title_frame = ttk.Frame(disaster_window, padding="15")
        title_frame.grid(row=0, column=0, sticky=(tk.W, tk.E), pady=(0, 10))

        warning_icon = "⚠️"
        title_label = ttk.Label(title_frame,
                                text=f"{warning_icon} {disaster_type}预警 {warning_icon}",
                                font=("Arial", 16, "bold"),
                                foreground="#e74c3c")
        title_label.grid(row=0, column=0, pady=(0, 10))

        desc_frame = ttk.LabelFrame(disaster_window, text="灾害描述", padding="10")
        desc_frame.grid(row=1, column=0, sticky=(tk.W, tk.E), padx=15, pady=(0, 15))

        desc_label = ttk.Label(desc_frame,
                               text=disaster_info["description"],
                               font=("Arial", 11),
                               wraplength=550,
                               justify="left")
        desc_label.grid(row=0, column=0, sticky=tk.W)

        solution_frame = ttk.LabelFrame(disaster_window, text="应对解决方案", padding="10")
        solution_frame.grid(row=2, column=0, sticky=(tk.W, tk.E, tk.N, tk.S), padx=15, pady=(0, 15))

        for i, solution in enumerate(disaster_info["solutions"]):
            solution_text = f"{i + 1}. {solution}"
            solution_label = ttk.Label(solution_frame,
                                       text=solution_text,
                                       font=("Arial", 10),
                                       wraplength=550,
                                       justify="left")
            solution_label.grid(row=i, column=0, sticky=tk.W, pady=2)

        crop_advice_frame = ttk.LabelFrame(disaster_window,
                                           text=f"{self.current_crop}专项防护建议",
                                           padding="10")
        crop_advice_frame.grid(row=3, column=0, sticky=(tk.W, tk.E), padx=15, pady=(0, 15))

        crop_specific_advice = self.get_crop_specific_advice(disaster_type, self.current_crop)
        crop_advice_label = ttk.Label(crop_advice_frame,
                                      text=crop_specific_advice,
                                      font=("Arial", 10),
                                      wraplength=550,
                                      justify="left")
        crop_advice_label.grid(row=0, column=0, sticky=tk.W)

        button_frame = ttk.Frame(disaster_window, padding="10")
        button_frame.grid(row=4, column=0, sticky=(tk.E, tk.W))

        close_btn = ttk.Button(button_frame,
                               text="关闭",
                               command=disaster_window.destroy)
        close_btn.grid(row=0, column=0, padx=(0, 10))

        another_btn = ttk.Button(button_frame,
                                 text="模拟另一种灾害",
                                 command=lambda: self.simulate_another_disaster(disaster_window))
        another_btn.grid(row=0, column=1)

        disaster_window.columnconfigure(0, weight=1)
        disaster_window.rowconfigure(2, weight=1)
        solution_frame.columnconfigure(0, weight=1)

    def simulate_another_disaster(self, current_window):
        """模拟另一种灾害天气"""
        current_window.destroy()
        self.simulate_disaster_weather()

    def get_crop_specific_advice(self, disaster_type, crop_name):
        """获取针对特定作物的专项建议"""
        advice_map = {
            "暴雨": {
                "番茄": "番茄怕涝，需特别注意排水，避免根部腐烂",
                "黄瓜": "黄瓜需保持良好排水，雨后及时检查叶片病害",
                "辣椒": "辣椒不耐涝，需加强排水，防止落花落果",
                "草莓": "草莓果实易受雨水污染，需加强防护",
                "甜瓜": "甜瓜需防止积水，避免裂果和病害"
            },
            "大风": {
                "番茄": "番茄植株较高，需加固支架防止倒伏",
                "黄瓜": "黄瓜藤蔓易受损，需检查支架牢固性",
                "辣椒": "辣椒植株相对矮小，但需防止薄膜破损",
                "草莓": "草莓低矮，主要防止棚膜损坏",
                "甜瓜": "甜瓜需保护藤蔓和幼果不被风伤"
            },
            "低温寒潮": {
                "番茄": "番茄对低温敏感，需加强保温防冻害",
                "黄瓜": "黄瓜喜温，低温易导致生长停滞",
                "辣椒": "辣椒不耐寒，需防止低温落花",
                "草莓": "草莓花期需防冻，避免影响坐果",
                "甜瓜": "甜瓜需保持适宜温度，防止冷害"
            },
            "高温干旱": {
                "番茄": "番茄需防止日灼病，适时遮阳",
                "黄瓜": "黄瓜需充足水分，避免化瓜",
                "辣椒": "辣椒需防止落花，保持水分均衡",
                "草莓": "草莓需避免高温灼伤叶片和果实",
                "甜瓜": "甜瓜需防止高温导致品质下降"
            },
            "冰雹": {
                "番茄": "番茄果实易被砸伤，需及时清理",
                "黄瓜": "黄瓜叶片大面积受损影响光合作用",
                "辣椒": "辣椒果实和枝条易被冰雹打伤",
                "草莓": "草莓果实极易受损，需重点防护",
                "甜瓜": "甜瓜果实和叶片需防冰雹打击"
            },
            "连续阴雨": {
                "番茄": "番茄易发生晚疫病，需加强防治",
                "黄瓜": "黄瓜易得霜霉病，注意通风降湿",
                "辣椒": "辣椒易发生疫病，及时喷药预防",
                "草莓": "草莓易得灰霉病，保持棚内干燥",
                "甜瓜": "甜瓜需防止白粉病发生"
            }
        }

        return advice_map.get(disaster_type, {}).get(crop_name, "请根据作物特性采取相应防护措施")

    def generate_web_report(self):
        """生成网页报告"""
        try:
            # 选择保存路径
            file_path = filedialog.asksaveasfilename(
                defaultextension=".html",
                filetypes=[("HTML files", "*.html"), ("All files", "*.*")],
                title="保存网页报告"
            )

            if not file_path:
                return

            # 生成HTML内容
            html_content = self.create_html_report()

            # 保存文件
            with open(file_path, 'w', encoding='utf-8') as f:
                f.write(html_content)

            # 询问是否打开
            if messagebox.askyesno("成功", "网页报告已生成，是否立即打开？"):
                webbrowser.open('file://' + os.path.realpath(file_path))

        except Exception as e:
            messagebox.showerror("错误", f"生成网页报告时出错: {str(e)}")

    def create_html_report(self):
        """创建HTML报告内容"""
        current_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

        html = f"""
        <!DOCTYPE html>
        <html lang="zh-CN">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>气候分析报告 - {current_time}</title>
            <style>
                body {{
                    font-family: 'Microsoft YaHei', Arial, sans-serif;
                    margin: 0;
                    padding: 20px;
                    background-color: #f5f5f5;
                    color: #333;
                }}
                .container {{
                    max-width: 1200px;
                    margin: 0 auto;
                    background: white;
                    padding: 30px;
                    border-radius: 10px;
                    box-shadow: 0 0 20px rgba(0,0,0,0.1);
                }}
                .header {{
                    text-align: center;
                    border-bottom: 3px solid #2c5282;
                    padding-bottom: 20px;
                    margin-bottom: 30px;
                }}
                .header h1 {{
                    color: #2c5282;
                    margin: 0;
                }}
                .header .subtitle {{
                    color: #666;
                    font-size: 18px;
                }}
                .summary {{
                    background: #e8f4fd;
                    padding: 20px;
                    border-radius: 8px;
                    margin-bottom: 30px;
                }}
                .data-grid {{
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                    gap: 20px;
                    margin-bottom: 30px;
                }}
                .data-card {{
                    background: white;
                    border: 1px solid #e1e8ed;
                    border-radius: 8px;
                    padding: 20px;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                }}
                .data-card h3 {{
                    color: #2c5282;
                    border-bottom: 2px solid #e1e8ed;
                    padding-bottom: 10px;
                    margin-top: 0;
                }}
                .weather-table {{
                    width: 100%;
                    border-collapse: collapse;
                    margin: 20px 0;
                }}
                .weather-table th, .weather-table td {{
                    border: 1px solid #ddd;
                    padding: 12px;
                    text-align: left;
                }}
                .weather-table th {{
                    background-color: #2c5282;
                    color: white;
                }}
                .weather-table tr:nth-child(even) {{
                    background-color: #f8f9fa;
                }}
                .crop-analysis {{
                    background: #fff3cd;
                    padding: 20px;
                    border-radius: 8px;
                    border-left: 4px solid #ffc107;
                    margin: 20px 0;
                }}
                .timestamp {{
                    text-align: right;
                    color: #666;
                    font-style: italic;
                    margin-top: 30px;
                }}
                .map-placeholder {{
                    background: #e9ecef;
                    padding: 40px;
                    text-align: center;
                    border-radius: 8px;
                    margin: 20px 0;
                }}
            </style>
        </head>
        <body>
            <div class="container">
                <div class="header">
                    <h1>🌤️ 各地市气候分析报告</h1>
                    <div class="subtitle">大棚农作物发育期检测与气候可视化</div>
                </div>

                <div class="summary">
                    <h2>📊 报告概要</h2>
                    <p>生成时间: {current_time}</p>
                    <p>分析城市: {len(self.shandong_cities)} 个山东地市</p>
                    <p>主要农作物: {self.current_crop}</p>
                    <p>数据来源: 实时天气数据 + 智能分析</p>
                </div>

                <div class="data-grid">
                    <div class="data-card">
                        <h3>🌡️ 温度分析</h3>
                        {self.generate_temperature_html()}
                    </div>

                    <div class="data-card">
                        <h3>💧 湿度分析</h3>
                        {self.generate_humidity_html()}
                    </div>

                    <div class="data-card">
                        <h3>🌾 农作物适宜度</h3>
                        {self.generate_crop_suitability_html()}
                    </div>
                </div>

                <div class="crop-analysis">
                    <h3>📈 {self.current_crop}发育期分析</h3>
                    {self.generate_crop_analysis_html()}
                </div>

                <div>
                    <h3>🏙️ 各地市天气详情</h3>
                    {self.generate_city_weather_table()}
                </div>

                <div class="map-placeholder">
                    <h3>🗺️ 3D地形与气候分布图</h3>
                    <p>注: 3D交互式地图请在桌面应用程序中查看</p>
                    <p>当前模式: {self.threed_mode.get()} | 分析作物: {self.current_crop}</p>
                </div>

                <div class="timestamp">
                    报告生成时间: {current_time}
                </div>
            </div>
        </body>
        </html>
        """

        return html

    def generate_temperature_html(self):
        """生成温度分析HTML"""
        temps = []
        for city in self.shandong_cities.keys():
            if city in self.all_cities_data:
                data = self.all_cities_data[city]
                if data and "now" in data:
                    temp = data["now"].get('temp', 'N/A')
                    if temp != 'N/A':
                        try:
                            temps.append(float(temp))
                        except ValueError:
                            continue

        if not temps:
            return "<p>暂无温度数据</p>"

        avg_temp = sum(temps) / len(temps)
        max_temp = max(temps)
        min_temp = min(temps)
        max_city = self.get_city_with_max_value('temp')
        min_city = self.get_city_with_min_value('temp')

        return f"""
        <p>平均温度: <strong>{avg_temp:.1f}°C</strong></p>
        <p>最高温度: <strong>{max_temp:.1f}°C</strong> ({max_city})</p>
        <p>最低温度: <strong>{min_temp:.1f}°C</strong> ({min_city})</p>
        <p>温度范围: {min_temp:.1f}°C ~ {max_temp:.1f}°C</p>
        """

    def generate_humidity_html(self):
        """生成湿度分析HTML"""
        humidities = []
        for city in self.shandong_cities.keys():
            if city in self.all_cities_data:
                data = self.all_cities_data[city]
                if data and "now" in data:
                    humidity = data["now"].get('humidity', 'N/A')
                    if humidity != 'N/A':
                        try:
                            humidities.append(float(humidity))
                        except ValueError:
                            continue

        if not humidities:
            return "<p>暂无湿度数据</p>"

        avg_humidity = sum(humidities) / len(humidities)
        max_humidity = max(humidities)
        min_humidity = min(humidities)

        return f"""
        <p>平均湿度: <strong>{avg_humidity:.1f}%</strong></p>
        <p>最高湿度: <strong>{max_humidity:.1f}%</strong></p>
        <p>最低湿度: <strong>{min_humidity:.1f}%</strong></p>
        <p>湿度适宜范围: 50% - 80%</p>
        """

    def generate_crop_suitability_html(self):
        """生成农作物适宜度HTML"""
        suitabilities = []
        for city in self.shandong_cities.keys():
            if city in self.all_cities_data:
                data = self.all_cities_data[city]
                if data and "now" in data:
                    now_data = data["now"]
                    try:
                        temp = float(now_data.get('temp', 0))
                        humidity = float(now_data.get('humidity', 0))
                        suitability = self.calculate_crop_suitability(temp, humidity)
                        suitabilities.append(suitability)
                    except (ValueError, TypeError):
                        continue

        if not suitabilities:
            return "<p>暂无适宜度数据</p>"

        avg_suitability = sum(suitabilities) / len(suitabilities)
        max_suitability = max(suitabilities)
        min_suitability = min(suitabilities)
        best_city = self.get_city_with_max_suitability()

        rating = "优秀" if avg_suitability >= 80 else "良好" if avg_suitability >= 60 else "一般" if avg_suitability >= 40 else "较差"

        return f"""
        <p>平均适宜度: <strong>{avg_suitability:.1f}%</strong> ({rating})</p>
        <p>最高适宜度: <strong>{max_suitability:.1f}%</strong> ({best_city})</p>
        <p>最低适宜度: <strong>{min_suitability:.1f}%</strong></p>
        <p>最适宜种植地区: {best_city}</p>
        """

    def generate_crop_analysis_html(self):
        """生成农作物分析HTML"""
        best_city = self.get_city_with_max_suitability()
        if best_city in self.all_cities_data:
            data = self.all_cities_data[best_city]
            if data and "now" in data:
                now_data = data["now"]
                try:
                    temp = float(now_data.get('temp', 0))
                    humidity = float(now_data.get('humidity', 0))
                    best_stage = self.get_best_development_stage(
                        self.crops[self.current_crop], temp, humidity
                    )
                    advice = self.get_growing_advice(best_stage)

                    return f"""
                    <p>当前最适宜发育期: <strong>{best_stage}</strong></p>
                    <p>最佳种植地区: <strong>{best_city}</strong></p>
                    <p>当前温度: {temp:.1f}°C | 当前湿度: {humidity:.1f}%</p>
                    <p>种植建议: {advice}</p>
                    """
                except (ValueError, TypeError):
                    pass

        return "<p>无法生成详细分析数据</p>"

    def generate_city_weather_table(self):
        """生成城市天气表格HTML"""
        table_html = """
        <table class="weather-table">
            <thead>
                <tr>
                    <th>城市</th>
                    <th>天气</th>
                    <th>温度</th>
                    <th>湿度</th>
                    <th>风向</th>
                    <th>风力</th>
                    <th>适宜度</th>
                </tr>
            </thead>
            <tbody>
        """

        for city in self.shandong_cities.keys():
            if city in self.all_cities_data:
                data = self.all_cities_data[city]
                if data and "now" in data:
                    now_data = data["now"]
                    try:
                        temp = float(now_data.get('temp', 0))
                        humidity = float(now_data.get('humidity', 0))
                        suitability = self.calculate_crop_suitability(temp, humidity)

                        table_html += f"""
                <tr>
                    <td>{city}</td>
                    <td>{now_data.get('text', 'N/A')}</td>
                    <td>{now_data.get('temp', 'N/A')}°C</td>
                    <td>{now_data.get('humidity', 'N/A')}%</td>
                    <td>{now_data.get('windDir', 'N/A')}</td>
                    <td>{now_data.get('windScale', 'N/A')}级</td>
                    <td>{suitability:.1f}%</td>
                </tr>
                        """
                    except (ValueError, TypeError):
                        table_html += f"""
                <tr>
                    <td>{city}</td>
                    <td colspan="6">数据异常</td>
                </tr>
                        """

        table_html += """
            </tbody>
        </table>
        """

        return table_html

    def get_city_with_max_value(self, field):
        """获取指定字段值最大的城市"""
        max_value = -float('inf')
        max_city = "未知"

        for city in self.shandong_cities.keys():
            if city in self.all_cities_data:
                data = self.all_cities_data[city]
                if data and "now" in data:
                    value = data["now"].get(field, 'N/A')
                    if value != 'N/A':
                        try:
                            num_value = float(value)
                            if num_value > max_value:
                                max_value = num_value
                                max_city = city
                        except ValueError:
                            continue

        return max_city

    def get_city_with_min_value(self, field):
        """获取指定字段值最小的城市"""
        min_value = float('inf')
        min_city = "未知"

        for city in self.shandong_cities.keys():
            if city in self.all_cities_data:
                data = self.all_cities_data[city]
                if data and "now" in data:
                    value = data["now"].get(field, 'N/A')
                    if value != 'N/A':
                        try:
                            num_value = float(value)
                            if num_value < min_value:
                                min_value = num_value
                                min_city = city
                        except ValueError:
                            continue

        return min_city

    def get_city_with_max_suitability(self):
        """获取适宜度最高的城市"""
        max_suitability = -1
        best_city = "未知"

        for city in self.shandong_cities.keys():
            if city in self.all_cities_data:
                data = self.all_cities_data[city]
                if data and "now" in data:
                    now_data = data["now"]
                    try:
                        temp = float(now_data.get('temp', 0))
                        humidity = float(now_data.get('humidity', 0))
                        suitability = self.calculate_crop_suitability(temp, humidity)
                        if suitability > max_suitability:
                            max_suitability = suitability
                            best_city = city
                    except (ValueError, TypeError):
                        continue






        return best_city


def main():
    try:
        root = tk.Tk()
        app = ShandongWeatherVisualization(root)
        root.mainloop()
    except Exception as e:
        print(f"出错: {e}")
        import traceback
        traceback.print_exc()
        input("按任意键退出...")



if __name__ == "__main__":
    main()